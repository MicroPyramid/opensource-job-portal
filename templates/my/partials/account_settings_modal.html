<!-- Account Settings Edit Modal -->
<div id="accountSettingsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
  <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <!-- Modal Header -->
      <div class="flex items-center justify-between pb-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900 flex items-center">
          <i data-lucide="settings" class="w-5 h-5 mr-2 text-blue-600"></i>
          Account Settings
        </h3>
        <button id="closeAccountSettingsModal" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <!-- Modal Content -->
      <form id="accountSettingsForm" class="py-6 space-y-6">
        {% csrf_token %}
        
        <!-- Notification Settings Section -->
        <div class="space-y-4">
          <h4 class="text-md font-semibold text-gray-900 flex items-center">
            <i data-lucide="bell" class="w-4 h-4 mr-2 text-blue-600"></i>
            Notification Settings
          </h4>
          
          <div class="space-y-3 pl-6">
            <!-- Email Notifications -->
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <label class="text-sm font-medium text-gray-700">Email Notifications</label>
                <p class="text-xs text-gray-500 mt-1">Receive job alerts, application updates, and other notifications via email</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer ml-4">
                <input type="checkbox" id="emailNotifications" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>
            
            <!-- Show Email to Recruiters -->
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <label class="text-sm font-medium text-gray-700">Show Email to Recruiters</label>
                <p class="text-xs text-gray-500 mt-1">Allow recruiters to see your email address in applications</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer ml-4">
                <input type="checkbox" id="showEmail" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>
          </div>
        </div>

        <!-- Job Seeking Status Section -->
        <div class="space-y-4 border-t border-gray-200 pt-6">
          <h4 class="text-md font-semibold text-gray-900 flex items-center">
            <i data-lucide="briefcase" class="w-4 h-4 mr-2 text-green-600"></i>
            Job Seeking Status
          </h4>
          
          <div class="space-y-3 pl-6">
            <!-- Looking for Job -->
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <label class="text-sm font-medium text-gray-700">Actively Looking for Job</label>
                <p class="text-xs text-gray-500 mt-1">You are actively searching for new job opportunities</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer ml-4">
                <input type="checkbox" id="isLookingForJob" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>
            
            <!-- Open to Offers -->
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <label class="text-sm font-medium text-gray-700">Open to Job Offers</label>
                <p class="text-xs text-gray-500 mt-1">You are open to hearing about new opportunities</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer ml-4">
                <input type="checkbox" id="isOpenToOffers" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>
            
            <!-- Willing to Relocate -->
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <label class="text-sm font-medium text-gray-700">Willing to Relocate</label>
                <p class="text-xs text-gray-500 mt-1">You are open to relocating for the right opportunity</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer ml-4">
                <input type="checkbox" id="relocation" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>
          </div>
        </div>

        <!-- Email Subscription Section -->
        <div class="space-y-4 border-t border-gray-200 pt-6">
          <h4 class="text-md font-semibold text-gray-900 flex items-center">
            <i data-lucide="mail" class="w-4 h-4 mr-2 text-purple-600"></i>
            Email Subscriptions
          </h4>
          
          <div class="space-y-3 pl-6">
            <!-- Unsubscribe from all emails -->
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <label class="text-sm font-medium text-gray-700">Unsubscribe from All Emails</label>
                <p class="text-xs text-gray-500 mt-1">Stop receiving all promotional and marketing emails</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer ml-4">
                <input type="checkbox" id="isUnsubscribe" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
              </label>
            </div>
          </div>
        </div>

        <!-- Modal Actions -->
        <div class="flex items-center justify-end space-x-3 pt-6 border-t border-gray-200">
          <button type="button" id="cancelAccountSettings" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
            Cancel
          </button>
          <button type="submit" class="px-6 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors inline-flex items-center">
            <span id="accountSettingsSubmitSpinner" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white hidden">
              <i data-lucide="loader-2" class="w-4 h-4"></i>
            </span>
            <span id="accountSettingsSubmitText">Save Changes</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('accountSettingsModal');
    const editBtn = document.getElementById('editAccountSettingsBtn');
    const closeBtn = document.getElementById('closeAccountSettingsModal');
    const cancelBtn = document.getElementById('cancelAccountSettings');
    const form = document.getElementById('accountSettingsForm');
    
    // Form fields
    const emailNotifications = document.getElementById('emailNotifications');
    const showEmail = document.getElementById('showEmail');
    const isLookingForJob = document.getElementById('isLookingForJob');
    const isOpenToOffers = document.getElementById('isOpenToOffers');
    const relocation = document.getElementById('relocation');
    const isUnsubscribe = document.getElementById('isUnsubscribe');

    // Open modal
    if (editBtn) {
        editBtn.addEventListener('click', function() {
            loadAccountSettings();
            modal.classList.remove('hidden');
        });
    }

    // Close modal
    function closeModal() {
        modal.classList.add('hidden');
        resetForm();
    }

    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    if (cancelBtn) cancelBtn.addEventListener('click', closeModal);

    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });

    // Load current account settings
    function loadAccountSettings() {
        fetch('{% url "candidate:edit_account_settings" %}', {
            method: 'GET',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Populate form fields
                emailNotifications.checked = data.data.email_notifications;
                showEmail.checked = data.data.show_email;
                isLookingForJob.checked = data.data.is_looking_for_job;
                isOpenToOffers.checked = data.data.is_open_to_offers;
                relocation.checked = data.data.relocation;
                isUnsubscribe.checked = data.data.is_unsubscribe;
            } else {
                showNotification('Error loading account settings', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading account settings:', error);
            showNotification('Error loading account settings', 'error');
        });
    }

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('accountSettingsSubmitText');
        const spinner = document.getElementById('accountSettingsSubmitSpinner');
        
        submitBtn.textContent = 'Saving...';
        spinner.classList.remove('hidden');

        const formData = {
            email_notifications: emailNotifications.checked,
            show_email: showEmail.checked,
            is_looking_for_job: isLookingForJob.checked,
            is_open_to_offers: isOpenToOffers.checked,
            relocation: relocation.checked,
            is_unsubscribe: isUnsubscribe.checked
        };

        fetch('{% url "candidate:edit_account_settings" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                updateAccountSettingsDisplay();
                closeModal();
            } else {
                showNotification(data.error || 'Error updating account settings', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred while updating account settings', 'error');
        })
        .finally(() => {
            submitBtn.textContent = 'Save Changes';
            spinner.classList.add('hidden');
        });
    });

    // Update account settings display in the main page
    function updateAccountSettingsDisplay() {
        // Update email notification status
        const emailNotifElement = document.querySelector('#emailNotificationStatus span');
        if (emailNotifElement) {
            if (emailNotifications.checked) {
                emailNotifElement.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
                emailNotifElement.innerHTML = '<i data-lucide="check" class="w-3 h-3 mr-1"></i>On';
            } else {
                emailNotifElement.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800';
                emailNotifElement.innerHTML = '<i data-lucide="x" class="w-3 h-3 mr-1"></i>Off';
            }
        }
        
        // Update show email status
        const showEmailElement = document.querySelector('#showEmailStatus span');
        if (showEmailElement) {
            if (showEmail.checked) {
                showEmailElement.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
                showEmailElement.innerHTML = '<i data-lucide="check" class="w-3 h-3 mr-1"></i>Public';
            } else {
                showEmailElement.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800';
                showEmailElement.innerHTML = '<i data-lucide="eye-off" class="w-3 h-3 mr-1"></i>Private';
            }
        }
        
        // Update job seeking status
        const jobStatusElement = document.querySelector('#jobSeekingStatus span');
        if (jobStatusElement) {
            if (isLookingForJob.checked) {
                jobStatusElement.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
                jobStatusElement.innerHTML = '<i data-lucide="search" class="w-3 h-3 mr-1"></i>Looking';
            } else if (isOpenToOffers.checked) {
                jobStatusElement.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800';
                jobStatusElement.innerHTML = '<i data-lucide="inbox" class="w-3 h-3 mr-1"></i>Open';
            } else {
                jobStatusElement.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800';
                jobStatusElement.innerHTML = '<i data-lucide="pause" class="w-3 h-3 mr-1"></i>Not Looking';
            }
        }
        
        // Update relocation status
        const relocationElement = document.querySelector('#relocationStatus span');
        if (relocationElement) {
            if (relocation.checked) {
                relocationElement.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
                relocationElement.innerHTML = '<i data-lucide="check" class="w-3 h-3 mr-1"></i>Yes';
            } else {
                relocationElement.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800';
                relocationElement.innerHTML = '<i data-lucide="x" class="w-3 h-3 mr-1"></i>No';
            }
        }
        
        // Re-initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    // Reset form
    function resetForm() {
        form.reset();
    }

    // Show notification
    function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-medium z-50 ${
            type === 'success' ? 'bg-green-500' : 'bg-red-500'
        }`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
});
</script>
