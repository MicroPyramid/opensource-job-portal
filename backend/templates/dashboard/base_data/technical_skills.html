{% extends 'dashboard/base.html' %}
{% load thumbnail %}
{% load page_tags %}
{% block stage %}
<div class="space-y-6">
  <!-- Page Header -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl font-semibold text-neutral-900">Technical Skills</h1>
      <p class="text-sm text-neutral-500 mt-0.5">Manage technical skills for job posts</p>
    </div>
    <div class="flex flex-wrap gap-2">
      <a href="{% url 'dashboard:tech_skills' %}?status=active" class="px-3 py-1.5 rounded-full text-sm font-medium transition-colors {% if status == 'active' %}bg-primary-500 text-white{% else %}bg-neutral-100 text-neutral-600 hover:bg-neutral-200{% endif %}">Active</a>
      <a href="{% url 'dashboard:tech_skills' %}?status=inactive" class="px-3 py-1.5 rounded-full text-sm font-medium transition-colors {% if status == 'inactive' %}bg-primary-500 text-white{% else %}bg-neutral-100 text-neutral-600 hover:bg-neutral-200{% endif %}">Inactive</a>
      <a href="{% url 'dashboard:tech_skills' %}?status=it" class="px-3 py-1.5 rounded-full text-sm font-medium transition-colors {% if status == 'it' %}bg-primary-500 text-white{% else %}bg-neutral-100 text-neutral-600 hover:bg-neutral-200{% endif %}">IT</a>
      <a href="{% url 'dashboard:tech_skills' %}?status=non-it" class="px-3 py-1.5 rounded-full text-sm font-medium transition-colors {% if status == 'non-it' %}bg-primary-500 text-white{% else %}bg-neutral-100 text-neutral-600 hover:bg-neutral-200{% endif %}">Non-IT</a>
      <a href="{% url 'dashboard:tech_skills' %}?status=other" class="px-3 py-1.5 rounded-full text-sm font-medium transition-colors {% if status == 'other' %}bg-primary-500 text-white{% else %}bg-neutral-100 text-neutral-600 hover:bg-neutral-200{% endif %}">Other</a>
    </div>
  </div>

  <!-- Add Form & Search -->
  <div class="bg-white rounded-xl border border-neutral-200 shadow-sm p-4">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Add Form -->
      <form id="addform" method="post" enctype="multipart/form-data" class="flex flex-wrap gap-2 items-end">
        <div class="flex-1 min-w-[150px]">
          <label class="block text-xs font-medium text-neutral-500 mb-1">Skill Name</label>
          <input type="text" class="form-control" id="name" name="name" placeholder="Enter skill name">
        </div>
        <div class="w-32">
          <label class="block text-xs font-medium text-neutral-500 mb-1">Type</label>
          <select class="form-control" name="skill_type">
            <option value="">Select Type</option>
            {% for type in skill_types %}
            <option value="{{ type.0 }}">{{ type.1 }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="w-32">
          <label class="block text-xs font-medium text-neutral-500 mb-1">Icon</label>
          <input type="file" class="text-sm" id="icon" name="icon">
          <input type="hidden" name="mode" value="add_skill">
        </div>
        <button type="submit" class="btn btn-primary">
          <i class="fa fa-plus mr-1"></i>Add
        </button>
      </form>

      <!-- Search Form -->
      <form id="search_form" method="GET" class="flex gap-2 items-end justify-end">
        <div class="flex-1 max-w-xs">
          <label class="block text-xs font-medium text-neutral-500 mb-1">Search</label>
          <input type="text" name="search" id="search" class="form-control" placeholder="Search skills..." value="{{ request.GET.search }}">
        </div>
        <input type="hidden" name="status" id="status" value="{% if request.GET.status %}{{request.GET.status}}{% endif %}">
        <input type="hidden" name="page" id="page" value="{% if request.GET.page %}{{request.GET.page}}{% else %}1{% endif %}">
        <button type="submit" class="btn btn-secondary">
          <i class="fa fa-search mr-1"></i>Search
        </button>
      </form>
    </div>
  </div>

  <!-- Skills List -->
  <div class="bg-white rounded-xl border border-neutral-200 shadow-sm overflow-hidden">
    <div class="divide-y divide-neutral-100">
      {% for skill in skills %}
      <div class="p-4 hover:bg-neutral-50 transition-colors">
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-4 flex-1">
            {% if skill.icon %}
            <div class="w-10 h-10 rounded-lg bg-neutral-100 flex items-center justify-center overflow-hidden flex-shrink-0">
              <img src="{{ skill.icon }}" class="w-full h-full object-cover" alt="{{ skill.name }}">
            </div>
            {% else %}
            <div class="w-10 h-10 rounded-lg bg-neutral-100 flex items-center justify-center flex-shrink-0">
              <i class="fa fa-code text-neutral-400"></i>
            </div>
            {% endif %}
            <div>
              <h4 class="font-medium text-neutral-900">{{ skill.name }}</h4>
              <div class="flex items-center gap-4 mt-1 text-sm text-neutral-500">
                <span><i class="fa fa-briefcase mr-1"></i>{{ skill.get_no_of_jobposts|length }} jobs</span>
                <span><i class="fa fa-users mr-1"></i>{{ skill.get_no_of_applicants|length }} applicants</span>
                <span><i class="fa fa-file mr-1"></i>{{ skill.get_no_of_resume_applicants|length }} resumes</span>
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            {% if skill.status == 'Active' %}
            <a href="/{{ skill.slug }}-jobs/" target="_blank" class="p-1.5 rounded-md hover:bg-neutral-100 text-neutral-600 transition-colors" title="View Jobs">
              <i class="fa fa-eye"></i>
            </a>
            {% endif %}
            <button type="button" class="edit-skill-btn p-1.5 rounded-md hover:bg-blue-100 text-blue-600 transition-colors" title="Edit">
              <i class="fa fa-edit"></i>
            </button>
            {% if skill.status == 'InActive' %}
            <a href="#" id="{{ skill.id }}" rel="{% if request.GET.page %}{{request.GET.page}}{% else %}1{% endif %}" class="enable-skill p-1.5 rounded-md hover:bg-green-100 text-green-600 transition-colors" title="Activate">
              <i class="fa fa-check"></i>
            </a>
            {% else %}
            <a href="#" id="{{ skill.id }}" rel="{% if request.GET.page %}{{request.GET.page}}{% else %}1{% endif %}" class="deactivate-skill p-1.5 rounded-md hover:bg-yellow-100 text-yellow-600 transition-colors" title="Deactivate">
              <i class="fa fa-times"></i>
            </a>
            {% endif %}
            <a data-href="{% url 'dashboard:delete_skill' skill_id=skill.id %}" class="delete_skill p-1.5 rounded-md hover:bg-red-100 text-red-600 transition-colors" title="Delete">
              <i class="fa fa-trash-o"></i>
            </a>
          </div>
        </div>
        <!-- Edit Panel -->
        <div class="edit_panel hidden mt-4 pt-4 border-t border-neutral-200">
          <form class="editform" id="{{ skill.id }}" method="post" enctype="multipart/form-data">
            <input type="hidden" name="id" value="{{ skill.id }}">
            <input type="hidden" name="mode" value="edit_skill">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-neutral-700 mb-1">Name</label>
                <input type="text" name="name" value="{{ skill.name }}" class="form-control">
              </div>
              <div>
                <label class="block text-sm font-medium text-neutral-700 mb-1">Slug</label>
                <input type="text" name="slug" value="{{ skill.slug }}" class="form-control">
              </div>
              <div>
                <label class="block text-sm font-medium text-neutral-700 mb-1">Skill Type</label>
                <select name="skill_type" class="form-control">
                  <option value="">Select Type</option>
                  {% for type in skill_types %}
                  <option value="{{ type.0 }}" {% if skill.skill_type == type.0 %}selected{% endif %}>{{ type.1 }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-neutral-700 mb-1">Icon</label>
                <input type="file" name="icon" class="text-sm">
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-neutral-700 mb-1">Meta Data (JSON)</label>
                <textarea name="meta" rows="2" class="form-control" placeholder="Meta data in JSON format"></textarea>
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-neutral-700 mb-1">Page Content</label>
                <textarea class="form-control ckeditor_page_content" name="ckeditor_page_content_{{ skill.id }}" id="ckeditor_page_content_{{ skill.id }}" rows="4">{{ skill.page_content }}</textarea>
                <input type="hidden" name="page_content" id="page_content_{{ skill.id }}">
              </div>
            </div>
            <input type="hidden" name="page" value="{% if request.GET.page %}{{request.GET.page}}{% else %}1{% endif %}">
            <div class="flex justify-end gap-2 mt-4">
              <button type="button" class="cancel-edit btn btn-secondary">Cancel</button>
              <button type="submit" class="update_btn btn btn-primary">
                <i class="fa fa-check mr-1"></i>Update
              </button>
            </div>
          </form>
        </div>
      </div>
      {% empty %}
      <div class="p-12 text-center">
        <div class="w-16 h-16 rounded-full bg-neutral-100 flex items-center justify-center mx-auto mb-4">
          <i class="fa fa-code text-2xl text-neutral-400"></i>
        </div>
        <p class="text-neutral-500">No skills found</p>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Pagination -->
  {% if skills %}
  {% get_page current_page last_page as pages %}
  {% if last_page > 1 %}
  <div class="flex justify-center">
    <nav class="inline-flex items-center gap-1">
      {% if current_page != 1 %}
      <a href="?{% if search %}search={{ search }}&{% endif %}{% if status %}status={{ status }}&{% endif %}page={{ previous_page }}" class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-neutral-200 bg-white text-neutral-600 hover:bg-neutral-50 transition-colors">
        <i class="fa fa-angle-double-left"></i>
      </a>
      <a href="?{% if search %}search={{ search }}&{% endif %}{% if status %}status={{ status }}&{% endif %}page={{ prev_page }}" class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-neutral-200 bg-white text-neutral-600 hover:bg-neutral-50 transition-colors">
        <i class="fa fa-angle-left"></i>
      </a>
      {% endif %}
      {% for s in pages %}
      <a href="?{% if search %}search={{ search }}&{% endif %}{% if status %}status={{ status }}&{% endif %}page={{ s }}" class="inline-flex items-center justify-center w-9 h-9 rounded-lg border text-sm font-medium transition-colors {% if s == current_page %}border-primary-500 bg-primary-500 text-white{% else %}border-neutral-200 bg-white text-neutral-600 hover:bg-neutral-50{% endif %}">
        {{ s }}
      </a>
      {% endfor %}
      {% if current_page != last_page %}
      <a href="?{% if search %}search={{ search }}&{% endif %}{% if status %}status={{ status }}&{% endif %}page={{ aft_page }}" class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-neutral-200 bg-white text-neutral-600 hover:bg-neutral-50 transition-colors">
        <i class="fa fa-angle-right"></i>
      </a>
      <a href="?{% if search %}search={{ search }}&{% endif %}{% if status %}status={{ status }}&{% endif %}page={{ after_page }}" class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-neutral-200 bg-white text-neutral-600 hover:bg-neutral-50 transition-colors">
        <i class="fa fa-angle-double-right"></i>
      </a>
      {% endif %}
    </nav>
  </div>
  {% endif %}
  {% endif %}
</div>
{% endblock stage %}

{% block script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.3.0/jquery.form.min.js"></script>
<script type="text/javascript">
$(document).ready(function() {
  // Edit button toggle
  $('.edit-skill-btn').click(function(e) {
    e.preventDefault();
    const editPanel = $(this).closest('.p-4').find('.edit_panel');
    editPanel.toggleClass('hidden');

    if (!editPanel.hasClass('hidden')) {
      const ckeditorName = editPanel.find('.ckeditor_page_content').attr('name');
      if (ckeditorName && !CKEDITOR.instances[ckeditorName]) {
        CKEDITOR.config.allowedContent = true;
        CKEDITOR.replace(ckeditorName);
      }
    }
  });

  // Cancel edit
  $('.cancel-edit').click(function(e) {
    e.preventDefault();
    $(this).closest('.edit_panel').addClass('hidden');
  });

  // Add form
  $('form#addform').ajaxForm({
    type: 'POST',
    dataType: 'json',
    url: "{% url 'dashboard:tech_skills' %}",
    success: function(data) {
      if (data.error == false) {
        open_dialog_with_url(data.message, 'Success!!!', "{{request.get_full_path}}")
      } else {
        for (var key in data.message) {
          open_dialog(data.message[key], 'Error!')
        }
      }
    }
  });

  // Deactivate skill
  $('.deactivate-skill').click(function(e) {
    e.preventDefault();
    var href = $(this).attr('id') + '/';
    var page = $(this).attr('rel');
    $('#block_question').text('Do you want to deactivate this skill?');
    $('#block_question').dialog({
      modal: true,
      dialogClass: "no-close",
      draggable: false,
      title: "Confirm",
      buttons: [
        {
          text: "Yes",
          click: function() {
            $(this).dialog("close");
            $.post('/dashboard/skill/status/' + href, {"page": page}, function(data) {
              if (data.error) {
                open_dialog(data.response, 'Error!')
              } else {
                open_dialog_with_url('Skill deactivated successfully', 'Success!!!', "{{request.get_full_path}}")
              }
            }, 'json');
          }
        },
        {
          text: "No",
          click: function() {
            $(this).dialog("close");
          }
        }
      ]
    });
  });

  // Enable skill
  $('.enable-skill').click(function(e) {
    e.preventDefault();
    var href = $(this).attr('id') + '/';
    var page = $(this).attr('rel');
    $('#block_question').text('Do you want to activate this skill?');
    $('#block_question').dialog({
      modal: true,
      dialogClass: "no-close",
      draggable: false,
      title: "Confirm",
      buttons: [
        {
          text: "Yes",
          click: function() {
            $(this).dialog("close");
            $.post('/dashboard/skill/status/' + href, {"page": page}, function(data) {
              if (data.error) {
                open_dialog(data.response, 'Error!')
              } else {
                open_dialog_with_url('Skill activated successfully', 'Success!!!', "{{request.get_full_path}}")
              }
            }, 'json');
          }
        },
        {
          text: "No",
          click: function() {
            $(this).dialog("close");
          }
        }
      ]
    });
  });

  // Delete skill
  $('.delete_skill').click(function(e) {
    e.preventDefault();
    var href = $(this).attr('data-href');
    $('#block_question').text('Do you want to permanently remove this skill?');
    $('#block_question').dialog({
      modal: true,
      dialogClass: "no-close",
      draggable: false,
      title: "Confirm",
      buttons: [
        {
          text: "Yes",
          click: function() {
            $(this).dialog("close");
            $.post(href, {}, function(data) {
              if (data.error) {
                open_dialog(data.message, 'Error!')
              } else {
                open_dialog_with_url(data.message, 'Success!!!', "{{request.get_full_path}}")
              }
            }, 'json');
          }
        },
        {
          text: "No",
          click: function() {
            $(this).dialog("close");
          }
        }
      ]
    });
  });
});
</script>
{% endblock script %}
