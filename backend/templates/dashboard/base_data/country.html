{% extends 'dashboard/base.html' %}
{% block stage %}
<style type="text/css">
  .meta_data { display: none; }
</style>
<div class="space-y-6">
  <!-- Page Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-neutral-900">Location Management</h1>
      <p class="text-sm text-neutral-500 mt-0.5">Manage countries, states, and cities</p>
    </div>
  </div>

  <!-- Three Panel Layout -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Country Panel -->
    <div class="bg-white rounded-xl border border-neutral-200 shadow-sm overflow-hidden">
      <div class="px-4 py-3 border-b border-neutral-200 bg-neutral-50">
        <h3 class="text-sm font-semibold text-neutral-800 uppercase tracking-wider">
          <i class="fa fa-globe text-primary-500 mr-2"></i>Country (Job Posts)
        </h3>
      </div>

      <!-- Add Country Form -->
      <div class="p-4 border-b border-neutral-100 active_ticket_form" id="add_conform">
        <form id="newcountryform" method="post" class="flex gap-2">
          <input type="text" class="form-control flex-1 text-sm" name="country" id="country" placeholder="Country name">
          <button type="submit" class="btn btn-primary btn-sm whitespace-nowrap">
            <i class="fa fa-plus mr-1"></i>Add
          </button>
        </form>
      </div>

      <!-- Edit Country Form (hidden by default) -->
      <div class="p-4 border-b border-neutral-100 hidden" id="edit_conform">
        <form id="editcountryform" method="post" class="space-y-2">
          <input type="text" class="form-control text-sm" id="country_name" placeholder="Name" name="country">
          <input type="hidden" id="country_id">
          <input type="text" class="form-control text-sm" placeholder="Slug" id="country_slug" name="slug">
          <div class="flex gap-2">
            <button type="submit" class="btn btn-primary btn-sm">
              <i class="fa fa-save mr-1"></i>Save
            </button>
            <button type="button" id="btnconcancel" class="btn btn-secondary btn-sm">
              <i class="fa fa-times mr-1"></i>Cancel
            </button>
          </div>
        </form>
      </div>

      <!-- Country List -->
      <div class="max-h-96 overflow-y-auto divide-y divide-neutral-100" id="country-list-div">
        {% for country in countries %}
        <div class="ticket p-3 hover:bg-neutral-50 transition-colors flex items-center justify-between {% if country.status == 'Disabled' %}opacity-50{% endif %}">
          <a class="name_ticket text-sm font-medium text-primary-600 hover:text-primary-700 flex-1" id="{{ country.status }}" href="{{ country.id }}">
            {{ country.name }}
          </a>
          <span class="text-xs text-neutral-500 mx-2">({{ country.get_no_of_jobposts|length }})</span>
          <div class="flex items-center gap-1">
            <a class="actions_ticket p-1 rounded hover:bg-neutral-100 text-neutral-500" href="{{ country.id }}" id="{{ country.status }}">
              {% if country.status == "Enabled" %}
              <i class="fa-solid fa-toggle-off text-green-500"></i>
              {% else %}
              <i class="fa-solid fa-toggle-on text-neutral-400"></i>
              {% endif %}
            </a>
            <a class="remove_country delete p-1 rounded hover:bg-red-100 text-red-500" href="{{ country.id }}">
              <i class="fa-solid fa-trash-can text-xs"></i>
            </a>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- State Panel -->
    <div class="bg-white rounded-xl border border-neutral-200 shadow-sm overflow-hidden">
      <div class="px-4 py-3 border-b border-neutral-200 bg-neutral-50">
        <h3 class="text-sm font-semibold text-neutral-800 uppercase tracking-wider">
          <i class="fa fa-map text-primary-500 mr-2"></i>State
        </h3>
      </div>

      <!-- Add State Form -->
      <div class="p-4 border-b border-neutral-100 active_ticket_form" id="add_stform">
        <form id="newstateform" method="post" class="flex gap-2">
          <input type="text" class="form-control flex-1 text-sm" name="state" id="state" placeholder="State name">
          <button type="submit" class="btn btn-primary btn-sm whitespace-nowrap">
            <i class="fa fa-plus mr-1"></i>Add
          </button>
        </form>
      </div>

      <!-- Edit State Form (hidden by default) -->
      <div class="p-4 border-b border-neutral-100 hidden" id="edit_stform">
        <form id="editstateform" method="post" class="space-y-2">
          <input type="text" class="form-control text-sm" placeholder="State Name" id="state_name" name="state">
          <input type="hidden" id="state_id">
          <select id="state_country" class="form-control text-sm" name="country">
            {% for country in countries %}
            <option value="{{ country.id }}">{{ country.name }}</option>
            {% endfor %}
          </select>
          <input type="text" class="form-control text-sm" id="state_slug" placeholder="Slug" name="slug">
          <div class="flex gap-2">
            <button type="submit" class="btn btn-primary btn-sm">
              <i class="fa fa-save mr-1"></i>Save
            </button>
            <button type="button" id="btnstcancel" class="btn btn-secondary btn-sm">
              <i class="fa fa-times mr-1"></i>Cancel
            </button>
          </div>
        </form>
      </div>

      <!-- State List -->
      <div class="max-h-96 overflow-y-auto divide-y divide-neutral-100" id="state-list-div">
        <!-- Dynamically populated -->
      </div>
    </div>

    <!-- City Panel -->
    <div class="bg-white rounded-xl border border-neutral-200 shadow-sm overflow-hidden">
      <div class="px-4 py-3 border-b border-neutral-200 bg-neutral-50">
        <h3 class="text-sm font-semibold text-neutral-800 uppercase tracking-wider">
          <i class="fa fa-building text-primary-500 mr-2"></i>City
        </h3>
      </div>

      <!-- Add City Form -->
      <div class="p-4 border-b border-neutral-100 active_ticket_form" id="add_ctform">
        <form id="newcityform" method="post" action="{% url 'dashboard:country' %}" class="flex gap-2">
          <input type="text" class="form-control flex-1 text-sm" name="city" id="city" placeholder="City name">
          <button type="submit" class="btn btn-primary btn-sm whitespace-nowrap">
            <i class="fa fa-plus mr-1"></i>Add
          </button>
        </form>
      </div>

      <!-- Edit City Form (hidden by default) -->
      <div class="p-4 border-b border-neutral-100 hidden" id="edit_ctform">
        <form id="editcityform" method="post" action="{% url 'dashboard:country' %}" class="space-y-2">
          <input type="text" class="form-control text-sm" id="editcity" name="city" placeholder="City name">
          <select id="city_country" class="form-control text-sm" name="country">
            {% for country in countries %}
            <option value="{{ country.id }}">{{ country.name }}</option>
            {% endfor %}
          </select>
          <select id="city_state" class="form-control text-sm" name="state">
            <option value="">Select State</option>
            {% for state in states %}
            <option value="{{ state.id }}" class="hidden" id="city_{{ state.country.id }}">{{ state.name }}</option>
            {% endfor %}
          </select>
          <input type="text" class="form-control text-sm" placeholder="Slug" id="slug" name="slug">
          <input type="hidden" id="city_id">
          <textarea class="form-control text-sm meta_title" name="meta_title" id="meta_title" placeholder="City Meta Title" rows="2"></textarea>
          <textarea class="form-control text-sm meta_description" name="meta_description" id="meta_description" placeholder="City Meta Description" rows="2"></textarea>
          <textarea class="form-control text-sm internship_meta_title" name="internship_meta_title" id="internship_meta_title" placeholder="Internship Meta Title" rows="2"></textarea>
          <textarea class="form-control text-sm internship_meta_description" name="internship_meta_description" id="internship_meta_description" placeholder="Internship Meta Description" rows="2"></textarea>
          <div class="flex gap-2">
            <button type="submit" class="btn btn-primary btn-sm">
              <i class="fa fa-save mr-1"></i>Save
            </button>
            <button type="button" id="btnctcancel" class="btn btn-secondary btn-sm">
              <i class="fa fa-times mr-1"></i>Cancel
            </button>
          </div>
        </form>
      </div>

      <!-- City List -->
      <div class="max-h-96 overflow-y-auto divide-y divide-neutral-100" id="city-list-div">
        <!-- Dynamically populated -->
      </div>

      <!-- Add Other City Form -->
      <div class="p-4 border-t border-neutral-100 hidden" id="add_other_id">
        <form id="othercityform" method="post" action="{% url 'dashboard:country' %}" class="flex gap-2">
          <input type="text" class="form-control flex-1 text-sm" name="name" id="city" placeholder="City name">
          <input type="hidden" name="state" id="state">
          <input type="hidden" name="mode" value="add_other_city">
          <button type="submit" class="btn btn-primary btn-sm whitespace-nowrap">
            <i class="fa fa-plus mr-1"></i>Add
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock stage %}

{% block script %}
<script type="text/javascript">
$("#newcountryform").submit(function(e) {
  e.preventDefault();
  $.post('.', {mode: 'add_country', name: $('#country').val()}, function(data) {
    if (data.error == false) {
      open_dialog_with_url(data.message, 'Success!!!', ".")
    } else {
      open_dialog(data.message, 'Error!')
    }
  }, 'json');
});

$("#editcountryform").submit(function(e) {
  e.preventDefault();
  $.post('.', {
    mode: 'edit_country',
    id: $('#country_id').val(),
    name: $('#country_name').val(),
    slug: $('#country_slug').val()
  }, function(data) {
    if (data.error == false) {
      open_dialog_with_url(data.message, 'Success!!!', ".")
    } else {
      for (key in data.message) {
        $('#country_'+key).addClass('border-red-500');
        $('#country_'+key).prop('title', data.message[key])
      }
    }
  }, 'json');
});

$('#country-list-div').on('click', '.ticket a.name_ticket', function(e) {
  e.preventDefault();
  $('#country_slug, #country_name').removeClass('border-red-500');
  $('#country_name, #country_slug').prop('title', '')
  $('#country_id').val($(this).attr('href'));
  $('#country_name').val($(this).text().trim());
  $('#country-list-div').find('.bg-primary-50').removeClass('bg-primary-50');
  $(this).parent().addClass('bg-primary-50');
  $('#add_conform').addClass('hidden');
  $('#edit_conform').removeClass('hidden');
  if ($(this).attr('id') == "Disabled") {
    $('#add_conform').addClass('hidden');
    $('#edit_conform').addClass('hidden');
    $('#add_stform').addClass('hidden');
    $('#edit_stform').addClass('hidden');
    $('#add_ctform').addClass('hidden');
    $('#edit_ctform').addClass('hidden');
  } else {
    $('#add_stform').removeClass('hidden');
    $('#edit_stform').addClass('hidden');
  }
  $('#city-list-div').html('');
  $('#state').val('');
  $.post('.', {mode: 'get_states', c_id: $(this).attr('href')}, function(data) {
    if (data.error == true) {
      open_dialog(data.message, 'Error!')
    } else {
      $('#state-list-div').html(data.html);
      $('#city-list-div').html('');
      $('#country_slug').val(data.slug);
    }
  }, 'json');
});

$('#country-list-div').on('click', '.ticket .actions_ticket', function(e) {
  e.preventDefault();
  $.post('.', {mode: 'country_status', id: $(this).attr('href')}, function(data) {
    if (data.error == false) {
      open_dialog_with_url(data.message, 'Success!!!', ".")
    }
  }, 'json');
});

$('#country-list-div').on('click', '.remove_country', function(e) {
  e.preventDefault();
  var element = $(this).closest('.ticket')
  var id = $(this).attr('href')
  $('#block_question').text('Do you want to delete this Country?')
  $('#block_question').dialog({
    modal: true,
    dialogClass: "no-close",
    draggable: false,
    title: "Confirm",
    buttons: [
      {
        text: "OK",
        click: function() {
          $.post('.', {mode: 'remove_country', id: id}, function(data) {
            if (data.error == false) {
              open_dialog(data.message, 'Success!')
              element.remove()
            } else {
              open_dialog(data.message, 'Error!')
            }
          }, 'json');
          $(this).dialog("close");
        }
      },
      {
        text: "Cancel",
        click: function() {
          $(this).dialog("close");
        }
      }
    ]
  });
});

$('#btnconcancel').on("click", function(e) {
  e.preventDefault();
  $('#country_slug, #country_name').removeClass('border-red-500');
  $('#country_name, #country_slug').prop('title', '')
  $('#country-list-div').find('.bg-primary-50').removeClass('bg-primary-50');
  $('#country_id').val("")
  $('#add_conform').removeClass('hidden');
  $('#edit_conform').addClass('hidden');
  $('#add_stform').removeClass('hidden');
  $('#edit_stform').addClass('hidden');
  $('#add_ctform').removeClass('hidden');
  $('#edit_ctform').addClass('hidden');
  $('#state-list-div').html('');
  $('#city-list-div').html('');
});

$("#newstateform").submit(function(e) {
  e.preventDefault();
  if ($('#country_id').val()) {
    $.post('.', {
      mode: 'add_state',
      country: $('#country_id').val(),
      name: $('#state').val()
    }, function(data) {
      if (data.error == false) {
        $('#block_question').text(data.message)
        $('#block_question').dialog({
          modal: true,
          dialogClass: "no-close",
          draggable: false,
          title: "Success!!",
          buttons: [
            {
              text: "OK",
              click: function() {
                var newcontent = $('#state-list-div').html();
                newcontent += '<div class="ticket p-3 hover:bg-neutral-50 transition-colors flex items-center justify-between"><a class="name_ticket text-sm font-medium text-primary-600 hover:text-primary-700 flex-1" href="' + data.id + '">' + data.name + '(0)</a><div class="flex items-center gap-1"><a class="actions_ticket p-1 rounded hover:bg-neutral-100" href="' + data.id + '" id="' + data.status + '"><i class="fa-solid fa-toggle-off text-green-500"></i></a><a class="remove_states delete p-1 rounded hover:bg-red-100 text-red-500" href="' + data.id + '"><i class="fa-solid fa-trash-can text-xs"></i></a></div></div>';
                $('#state-list-div').html(newcontent);
                $(this).dialog("close");
              }
            }
          ]
        });
      } else {
        open_dialog(data.message, 'Error!')
      }
    }, 'json');
    $('#state').val('');
  } else {
    open_dialog("You can't add State, Please select country", 'Error!')
  }
});

$("#editstateform").submit(function(e) {
  e.preventDefault();
  $.post('.', {
    mode: 'edit_state',
    country: $('#state_country').val(),
    id: $('#state_id').val(),
    name: $('#state_name').val(),
    slug: $('#state_slug').val(),
  }, function(data) {
    if (data.error == false) {
      $('#block_question').text(data.message)
      $('#block_question').dialog({
        modal: true,
        dialogClass: "no-close",
        draggable: false,
        title: "Success!!",
        buttons: [
          {
            text: "OK",
            click: function() {
              $('#state-list-div').find('a.name_ticket').each(function() {
                if ($(this).attr('href') == $('#state_id').val()) {
                  $(this).text($('#state_name').val());
                }
              });
              $(this).dialog("close");
            }
          }
        ]
      });
    } else {
      for (var key in data.message) {
        $('#state_'+key).addClass('border-red-500');
        $('#state_'+key).prop('title', data.message[key])
      }
    }
  }, 'json');
});

$('#state-list-div').on('click', '.ticket a.name_ticket', function(e) {
  e.preventDefault();
  $('#state_name, #state_slug').removeClass('border-red-500');
  $('#state_name, #state_slug').prop('title', '')
  $('#state_id').val($(this).attr('href'));
  $('#state_name').val($(this).text().trim());
  $('#state-list-div').find('.bg-primary-50').removeClass('bg-primary-50');
  $(this).parent().addClass('bg-primary-50');
  if ($(this).attr('id') == "Disabled") {
    $('#add_stform').addClass('hidden');
    $('#edit_stform').addClass('hidden');
    $('#add_ctform').addClass('hidden');
    $('#edit_ctform').addClass('hidden');
  } else {
    $('#add_stform').addClass('hidden');
    $('#edit_stform').removeClass('hidden');
    $('#add_ctform').removeClass('hidden');
    $('#edit_ctform').addClass('hidden');
    $('#edit_conform').removeClass('hidden');
  }
  $('#city').val('');
  $.post('.', {mode: 'get_cities', s_id: $(this).attr('href')}, function(data) {
    if (data.error == true) {
      open_dialog(data.message, 'Error!')
    } else {
      $('#city-list-div').html(data.html);
      $('#state_country').val(data.country)
      $('#state_slug').val(data.state_slug)
    }
  }, 'json');
});

$('#state-list-div').on('click', '.ticket .actions_ticket', function(e) {
  e.preventDefault();
  $('#add_stform').removeClass('hidden');
  $('#edit_stform').addClass('hidden');
  $('#add_ctform').removeClass('hidden');
  $('#edit_ctform').addClass('hidden');
  $('#city-list-div').html('');
  $('#city').val('');
  var _this = $(this)
  $.post('.', {mode: 'state_status', id: $(this).attr('href')}, function(data) {
    if (data.error == false) {
      open_dialog(data.message, 'Info!')
      if ($(_this).find('i').hasClass('fa-toggle-on')) {
        $(_this).find('i').removeClass('fa-toggle-on text-neutral-400').addClass('fa-toggle-off text-green-500')
      } else {
        $(_this).find('i').removeClass('fa-toggle-off text-green-500').addClass('fa-toggle-on text-neutral-400')
      }
      $("#country-list-div .ticket").each(function() {
        if ($(this).find("a.name_ticket").attr('href') == data.country_id) {
          if (data.country_status == true) {
            if (!$(this).hasClass("opacity-50")) {
              $(this).find("a.name_ticket").attr('id', 'Disabled')
              $("#edit_conform").addClass("hidden")
              $("#add_conform").addClass("hidden")
              $(this).addClass("opacity-50");
            }
            $('#add_stform').addClass('hidden');
          } else {
            if ($(this).hasClass("opacity-50")) {
              $(this).find("a.name_ticket").attr('id', 'Enabled')
              $(this).removeClass("opacity-50");
            }
          }
        }
      });
    }
  }, 'json');

  if ($(this).attr('id') == "Enabled") {
    $(this).closest('.ticket').find('a.name_ticket').attr('id', 'Disabled')
    $(this).find('i').removeClass('fa-toggle-off text-green-500').addClass('fa-toggle-on text-neutral-400')
    $(this).closest('.ticket').addClass('opacity-50')
    $(this).attr('id', 'Disabled')
  } else {
    $(this).closest('.ticket').find('a.name_ticket').attr('id', 'Enabled')
    $(this).find('i').removeClass('fa-toggle-on text-neutral-400').addClass('fa-toggle-off text-green-500')
    $(this).closest('.ticket').removeClass('opacity-50')
    $(this).attr('id', 'Enabled')
  }
});

$('#state-list-div').on('click', '.remove_states', function(e) {
  e.preventDefault();
  var element = $(this).closest('.ticket')
  var id = $(this).attr('href')
  $('#block_question').text('Do you want to delete this State?')
  $('#block_question').dialog({
    modal: true,
    dialogClass: "no-close",
    draggable: false,
    title: "Confirm",
    buttons: [
      {
        text: "OK",
        click: function() {
          $.post('.', {mode: 'remove_state', id: id}, function(data) {
            if (data.error == false) {
              open_dialog(data.message, 'Success!')
              element.remove()
            } else {
              open_dialog(data.message, 'Error!')
            }
          }, 'json');
          $(this).dialog("close");
        }
      },
      {
        text: "Cancel",
        click: function() {
          $(this).dialog("close");
        }
      }
    ]
  });
});

$('#btnstcancel').on("click", function(e) {
  e.preventDefault();
  $('#state_name, #state_slug').removeClass('border-red-500');
  $('#state_name, #state_slug').prop('title', '')
  $('#state-list-div').find('.bg-primary-50').removeClass('bg-primary-50');
  $('#state_id').val("");
  $('#add_stform').removeClass('hidden');
  $('#edit_stform').addClass('hidden');
  $('#add_ctform').removeClass('hidden');
  $('#edit_ctform').addClass('hidden');
  $('#city-list-div').html('');
});

$("#newcityform").submit(function(e) {
  e.preventDefault();
  if ($('#state_id').val()) {
    $.post('.', {mode: 'add_city', state: $('#state_id').val(), name: $('#city').val()}, function(data) {
      if (data.error == false) {
        open_dialog(data.message, 'Success!')
        var newcontent = $('#city-list-div').html();
        newcontent += '<div class="ticket p-3 hover:bg-neutral-50 transition-colors flex items-center justify-between"><a class="name_ticket text-sm font-medium text-primary-600 hover:text-primary-700 flex-1" href="' + data.id + '">' + data.name + '</a><div class="flex items-center gap-1"><a class="actions_ticket p-1 rounded hover:bg-neutral-100" href="' + data.id + '" id="' + data.status + '"><i class="fa-solid fa-toggle-off text-green-500"></i></a><a class="remove_city delete p-1 rounded hover:bg-red-100 text-red-500" href="' + data.id + '"><i class="fa-solid fa-trash-can text-xs"></i></a></div></div>';
        $('#city-list-div').html(newcontent);
      } else {
        open_dialog(data.message, 'Error!')
      }
    }, 'json');
    $('#city').val('');
  } else {
    open_dialog("You can't add city, Please select State", 'Info!')
  }
});

$("#editcityform").submit(function(e) {
  e.preventDefault();
  meta_title = $(this).find('.meta_title').val()
  meta_description = $(this).find('.meta_description').val()
  internship_meta_description = $(this).find('.internship_meta_description').val()
  internship_meta_title = $(this).find('.internship_meta_title').val()
  href = $(this).attr('href')
  $('#block_question').text('Do you want to update city details?')
  $('#block_question').dialog({
    modal: true,
    dialogClass: "no-close",
    draggable: false,
    title: "Info!!",
    buttons: [
      {
        text: "OK",
        click: function() {
          $.post('.', {
            mode: 'edit_city',
            state: $('#city_state').val(),
            id: $('#city_id').val(),
            name: $('#editcity').val(),
            slug: $('#slug').val(),
            'meta_title': meta_title,
            'meta_description': meta_description,
            'internship_meta_description': internship_meta_description,
            'internship_meta_title': internship_meta_title
          }, function(data) {
            if (data.error == false) {
              open_dialog(data.message, 'Info!')
              $('#city-list-div').find('a.name_ticket').each(function() {
                if (href == $('#city_id').val()) {
                  $("#editcityform").text($('#editcity').val());
                }
              });
            } else {
              for (var key in data.message) {
                open_dialog(data.message[key], 'Error!')
              }
            }
          }, 'json');
          $(this).dialog("close");
        }
      }
    ]
  });
});

$('#city-list-div').on('click', '.ticket a.name_ticket', function(e) {
  e.preventDefault();
  $('#city_id').val($(this).attr('href'));
  $('#editcity').val($(this).text().trim());
  $('#meta_title').val($(this).siblings('.actions_ticket').find('.meta_title').text());
  $('#meta_description').val($(this).siblings('.actions_ticket').find('.meta_description').text());
  $('#internship_meta_title').val($(this).siblings('.actions_ticket').find('.internship_meta_title').text());
  $('#internship_meta_description').val($(this).siblings('.actions_ticket').find('.internship_meta_description').text());
  $('#city-list-div').find('.bg-primary-50').removeClass('bg-primary-50');
  $(this).parent().addClass('bg-primary-50');
  if ($(this).attr('id') == "Disabled") {
    $('#add_ctform').addClass('hidden');
    $('#edit_ctform').addClass('hidden');
  } else {
    $('#add_ctform').addClass('hidden');
    $('#edit_ctform').removeClass('hidden');
    $('#edit_stform').removeClass('hidden');
    $('#edit_conform').removeClass('hidden');
  }
  $.post('.', {mode: 'get_city_info', city: $(this).attr('href')}, function(data) {
    $('#city_country').val(data.country)
    $('#city_state').val(data.state)
    $('#slug').val(data.slug)
    $('select#city_state option[id="city_'+ data.country + '"]').removeClass('hidden');
  }, 'json');
});

$('#city-list-div').on('click', '.ticket .actions_ticket', function(e) {
  e.preventDefault();
  $('#add_ctform').removeClass('hidden');
  $('#edit_ctform').addClass('hidden');
  $('#city').val('');

  if ($(this).attr('id') == "Enabled") {
    $(this).closest('.ticket').find('a.name_ticket').attr('id', 'Disabled')
    $(this).find('i').removeClass('fa-toggle-off text-green-500').addClass('fa-toggle-on text-neutral-400')
    $(this).closest('.ticket').addClass('opacity-50')
    $(this).attr('id', 'Disabled')
  } else {
    $(this).closest('.ticket').find('a.name_ticket').attr('id', 'Enabled')
    $(this).find('i').removeClass('fa-toggle-on text-neutral-400').addClass('fa-toggle-off text-green-500')
    $(this).closest('.ticket').removeClass('opacity-50')
    $(this).attr('id', 'Enabled')
  }
  $.post('.', {mode: 'city_status', id: $(this).attr('href')}, function(data) {
    if (data.error == false) {
      open_dialog(data.message, 'Info!')
      $("#state-list-div .ticket").each(function() {
        if ($(this).find("a.name_ticket").attr('href') == data.state_id) {
          if (data.state_status == true) {
            if (!$(this).hasClass("opacity-50")) {
              $(this).find("a.name_ticket").attr('id', 'Disabled')
              $(this).addClass("opacity-50");
              $(this).find('.actions_ticket i').removeClass('fa-toggle-off text-green-500').addClass('fa-toggle-on text-neutral-400');
              $(this).find('.actions_ticket').attr('id', 'Disabled')
            }
            $('#add_ctform').addClass('hidden');
          } else {
            if ($(this).hasClass("opacity-50")) {
              $(this).find("a.name_ticket").attr('id', 'Enabled')
              $(this).removeClass("opacity-50");
              $(this).find('.actions_ticket i').removeClass('fa-toggle-on text-neutral-400').addClass('fa-toggle-off text-green-500');
              $(this).find('.actions_ticket').attr('id', 'Enabled')
              $('#edit_stform').removeClass('hidden');
              $('#edit_conform').removeClass('hidden');
            }
          }
        }
      });
      $("#country-list-div .ticket").each(function() {
        if ($(this).find("a.name_ticket").attr('href') == data.country_id) {
          if (data.country_status == true) {
            if (!$(this).hasClass("opacity-50")) {
              $(this).addClass("opacity-50");
              $(this).find('.actions_ticket i').removeClass('fa-toggle-off text-green-500').addClass('fa-toggle-on text-neutral-400');
            }
          } else {
            if ($(this).hasClass("opacity-50")) {
              $(this).removeClass("opacity-50");
              $(this).find('.actions_ticket i').removeClass('fa-toggle-on text-neutral-400').addClass('fa-toggle-off text-green-500');
            }
          }
        }
      });
    } else {
      open_dialog(data.message, 'Alert!')
    }
  }, 'json');
});

$('#city-list-div').on('click', '.remove_city', function(e) {
  e.preventDefault();
  var element = $(this).closest('.ticket')
  var id = $(this).attr('href')
  $('#block_question').text('Do you want to delete this City?')
  $('#block_question').dialog({
    modal: true,
    dialogClass: "no-close",
    draggable: false,
    title: "Confirm",
    buttons: [
      {
        text: "OK",
        click: function() {
          $.post('.', {mode: 'remove_city', id: id}, function(data) {
            if (data.error == false) {
              open_dialog(data.message, 'Success!')
              element.remove()
            } else {
              open_dialog(data.message, 'Error!')
            }
          }, 'json');
          $(this).dialog("close");
        }
      },
      {
        text: "Cancel",
        click: function() {
          $(this).dialog("close");
        }
      }
    ]
  });
});

$('#btnctcancel').on("click", function(e) {
  e.preventDefault();
  $('#city-list-div').find('.bg-primary-50').removeClass('bg-primary-50');
  $('#add_ctform').removeClass('hidden');
  $('#edit_ctform').addClass('hidden');
});

$("select#city_country").on('change', function(e) {
  $('select#city_state option').addClass('hidden')
  $('select#city_state').val('')
  $('select#city_state option[id="city_'+ $('#city_country').val() + '"]').removeClass('hidden');
});

$('#city-list-div').on('click', '.ticket a.add_other_city', function(e) {
  if ($(this).find('.fa').hasClass('fa-plus')) {
    var other_form = $('#add_other_id').removeClass('hidden').detach();
    $(this).parent().append(other_form)
    $(this).parent().find('#state').val($(this).attr('data-state'))
  } else {
    $(this).parent().find('#add_other_id').addClass('hidden')
  }
  $(this).find('.fa').toggleClass('fa-plus fa-times')
});

$("#othercityform").submit(function(e) {
  e.preventDefault();
  var state = $(this).find('#state').val()
  $.post('.', $(this).serialize(), function(data) {
    if (data.error == false) {
      $('#state-list-div .ticket a.name_ticket[href='+state+']').click()
      open_dialog('City Saved Successfully!', 'Success!!!', ".")
    } else {
      open_dialog(data.message, 'Error!')
    }
  }, 'json');
});
</script>
{% endblock script %}
