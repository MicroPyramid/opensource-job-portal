{% extends "dashboard/base.html" %}
{% load page_tags %}
{% load tz %}
{% load static %}
{% block stage %}
<div class="space-y-6">
  <!-- Page Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-neutral-900">Job Posts</h1>
      <p class="text-sm text-neutral-500 mt-1">Manage {{ job_type|title }} job listings</p>
    </div>
  </div>

  <!-- Main Card -->
  <div class="bg-white rounded-xl border border-neutral-200 shadow-sm overflow-hidden">
    <!-- Search & Filter -->
    <div class="p-4 border-b border-neutral-200">
      <form id="search_form" name="adv-search-form" method="POST" class="flex flex-wrap items-center gap-4">
        <div class="flex-1 min-w-[200px] max-w-sm">
          <div class="relative">
            <input type="text"
                   name="search"
                   id="search"
                   class="form-control pl-10"
                   placeholder="Search job posts..."
                   value="{{ request.POST.search }}"/>
            <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400"></i>
          </div>
          <input type="hidden" name="job_type" id="job_type" value="{{ job_type }}"/>
          <input type="hidden" name="page" id="page" value="{{ page }}"/>
        </div>
        <div class="relative w-64">
          <input type="text"
                 class="form-control pl-10"
                 id="reportrange"
                 name="timestamp"
                 value="{{ request.POST.timestamp }}"
                 placeholder="Select date range">
          <i class="fa fa-calendar absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400"></i>
        </div>
        <button type="submit" class="btn btn-primary">
          <i class="fa fa-search mr-2"></i>Search
        </button>
      </form>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-neutral-50 border-b border-neutral-200">
          <tr>
            <th class="px-4 py-3 text-left font-semibold text-neutral-700 w-[12%]">Job Title</th>
            <th class="px-4 py-3 text-left font-semibold text-neutral-700 w-[13%]">Location</th>
            <th class="px-4 py-3 text-left font-semibold text-neutral-700 w-[15%]">Company Name</th>
            <th class="px-4 py-3 text-left font-semibold text-neutral-700 w-[8%]">Status</th>
            <th class="px-4 py-3 text-left font-semibold text-neutral-700 w-[10%]">Posted By</th>
            <th class="px-4 py-3 text-left font-semibold text-neutral-700 w-[12%]">Posted On</th>
            <th class="px-4 py-3 text-center font-semibold text-neutral-700 w-[8%]">Applied</th>
            <th class="px-4 py-3 text-left font-semibold text-neutral-700 w-[22%]">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-neutral-100">
          {% for post in posts %}
          <tr class="job_detail hover:bg-neutral-50 transition-colors cursor-pointer
              {% if post.status == 'Pending' %}bg-yellow-50/50{% endif %}
              {% if post.status == 'Disabled' %}bg-red-50/30{% endif %}
              {% if post.status == 'Live' %}bg-green-50/30{% endif %}"
              data-href='/dashboard/jobpost/view/{{ post.id }}/'>
            <td class="px-4 py-3 font-medium text-neutral-900">{{ post.title }}</td>
            <td class="px-4 py-3 text-neutral-600 text-xs">
              {% for location in post.location.all %}
                {{ location.name }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            </td>
            <td class="px-4 py-3 text-neutral-600">
              {% if post.company %}{{ post.company.name }}{% else %}{{ post.company_name }}{% endif %}
            </td>
            <td class="px-4 py-3 status_{{ post.id }}">
              <span class="inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-full
                {% if post.status == 'Pending' %}bg-yellow-100 text-yellow-800{% endif %}
                {% if post.status == 'Published' %}bg-blue-100 text-blue-800{% endif %}
                {% if post.status == 'Live' %}bg-green-100 text-green-800{% endif %}
                {% if post.status == 'Disabled' %}bg-red-100 text-red-800{% endif %}
                {% if post.status == 'Draft' %}bg-neutral-100 text-neutral-600{% endif %}">
                {{ post.status }}
              </span>
            </td>
            <td class="px-4 py-3">
              <a href="{% url 'dashboard:view_recruiter' post.user.id %}"
                 class="text-primary-600 hover:text-primary-700 text-xs"
                 title="{% if post.user.company and post.user.company.company_type == 'Consultant' %}Consultant{% else %}Recruiter{% endif %}">
                {{ post.user.username }}
              </a>
            </td>
            <td class="px-4 py-3 text-neutral-600 text-xs">
              {{ post.published_on|timezone:'Asia/Calcutta'|date:"M. d, Y h:i a" }}
            </td>
            <td class="px-4 py-3 text-center">
              <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-primary-100 text-primary-700 text-xs font-semibold">
                {{ post.get_all_applied_users_count }}
              </span>
            </td>
            <td class="px-4 py-3">
              <div class="flex items-center gap-1">
                {% if post.user.id|slugify == request.user.id|slugify %}
                <a href="{% url 'dashboard:edit_govt_job' post.id %}"
                   class="edit-job inline-flex items-center justify-center w-8 h-8 rounded-lg text-neutral-500 hover:bg-blue-50 hover:text-blue-600 transition-colors"
                   title="Edit Job">
                  <i class="fa fa-edit"></i>
                </a>
                {% endif %}

                {% if post.status == 'Disabled' %}
                <a href="{% url 'dashboard:enable' post.id %}"
                   class="enable-job inline-flex items-center justify-center w-8 h-8 rounded-lg text-green-600 hover:bg-green-50 transition-colors"
                   title="Enable Job">
                  <i class="fa fa-check"></i>
                </a>
                {% else %}
                <a href="{% url 'dashboard:deactivate_job' post.id %}"
                   class="deactivate-job inline-flex items-center justify-center w-8 h-8 rounded-lg text-red-500 hover:bg-red-50 transition-colors"
                   title="Deactivate Job">
                  <i class="fa fa-times"></i>
                </a>
                {% endif %}

                {% if post.status == 'Pending' %}
                <a href="{% url 'dashboard:publish' post.id %}"
                   class="publish-job inline-flex items-center justify-center w-8 h-8 rounded-lg text-yellow-600 hover:bg-yellow-50 transition-colors"
                   title="Publish Job">
                  <i class="fa fa-hand-o-up"></i>
                </a>
                {% elif post.status == 'Published' %}
                <a href="{% url 'dashboard:publish' post.id %}"
                   class="live-job inline-flex items-center justify-center w-8 h-8 rounded-lg text-blue-600 hover:bg-blue-50 transition-colors"
                   title="Make Live">
                  <i class="fa fa-check"></i>
                </a>
                {% elif post.status == 'Live' %}
                <a href="{% url 'dashboard:publish' post.id %}"
                   class="live-job inline-flex items-center justify-center w-8 h-8 rounded-lg text-green-600 hover:bg-green-50 transition-colors"
                   title="Live">
                  <i class="fa fa-check"></i>
                </a>
                {% endif %}

                <a href="#" data-href="{% url 'dashboard:delete' post.id %}"
                   class="delete-job inline-flex items-center justify-center w-8 h-8 rounded-lg text-neutral-500 hover:bg-red-50 hover:text-red-600 transition-colors"
                   title="Delete Job">
                  <i class="fa-solid fa-trash-can"></i>
                </a>

                <a href="{% url 'dashboard:edit_job_title' post.id %}"
                   class="edit-job inline-flex items-center justify-center w-8 h-8 rounded-lg text-neutral-500 hover:bg-neutral-100 hover:text-neutral-700 transition-colors"
                   title="Edit Job Title">
                  <i class="fa fa-edit"></i>
                </a>

                {% if post.status == 'Live' %}
                <a data-href="{{post.slug}}"
                   class="front_end_url inline-flex items-center justify-center w-8 h-8 rounded-lg text-neutral-500 hover:bg-neutral-100 hover:text-neutral-700 transition-colors"
                   title="View on Site">
                  <i class="fa fa-eye"></i>
                </a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="px-4 py-12 text-center text-neutral-500">
              <div class="flex flex-col items-center">
                <i class="fa fa-briefcase text-4xl text-neutral-300 mb-3"></i>
                <p>No job posts found</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if last_page > 1 %}
    <div class="px-4 py-4 border-t border-neutral-200">
      {% get_page current_page last_page as pages %}
      <nav class="flex items-center justify-center gap-1">
        {% if current_page != 1 %}
        <a href="#" class="{{ previous_page }} page-nav inline-flex items-center justify-center w-9 h-9 rounded-lg text-neutral-500 hover:bg-neutral-100 transition-colors">
          <i class="fa fa-angle-double-left"></i>
        </a>
        <a href="#" class="{{ prev_page }} page-nav inline-flex items-center justify-center w-9 h-9 rounded-lg text-neutral-500 hover:bg-neutral-100 transition-colors">
          <i class="fa fa-angle-left"></i>
        </a>
        <a href="#" class="1 page-nav inline-flex items-center justify-center px-3 h-9 rounded-lg text-sm text-neutral-600 hover:bg-neutral-100 transition-colors">first</a>
        {% endif %}

        {% for s in pages %}
        <a href="#" class="{{ s }} page-nav inline-flex items-center justify-center w-9 h-9 rounded-lg text-sm font-medium transition-colors {% if s == current_page %}bg-primary-500 text-white{% else %}text-neutral-600 hover:bg-neutral-100{% endif %}">
          {{ s }}
        </a>
        {% endfor %}

        {% if current_page != last_page %}
        <a href="#" class="{{ last_page }} page-nav inline-flex items-center justify-center px-3 h-9 rounded-lg text-sm text-neutral-600 hover:bg-neutral-100 transition-colors">last</a>
        <a href="#" class="{{ aft_page }} page-nav inline-flex items-center justify-center w-9 h-9 rounded-lg text-neutral-500 hover:bg-neutral-100 transition-colors">
          <i class="fa fa-angle-right"></i>
        </a>
        <a href="#" class="{{ after_page }} page-nav inline-flex items-center justify-center w-9 h-9 rounded-lg text-neutral-500 hover:bg-neutral-100 transition-colors">
          <i class="fa fa-angle-double-right"></i>
        </a>
        {% endif %}
      </nav>
    </div>
    {% endif %}
  </div>
</div>
{% endblock stage %}

{% block script %}
<script type="text/javascript">
  $('.delete-job').click(function (e) {
    e.preventDefault();
    e.stopPropagation();
    href = $(this).attr('data-href')
    if (!confirm('Do you want to delete this Jobpost?')) return;

    $.post(href, $("form#jobform").serialize(), function (data) {
      if (data.error) {
        open_dialog(data.response, 'Error!')
      } else {
        open_dialog('Job Post Deleted Successfully', 'Success!')
        $('#search_form').submit();
      }
    }, 'json');
  });

  $('.fb_groups_post_job').click(function (e) {
    e.preventDefault();
    e.stopPropagation();
    href = $(this).attr('data-href')
    if (!confirm('Do you want to post this job in all fb groups?')) return;

    $.post(href, {}, function (data) {
      if (data.error) {
        open_dialog(data.response, 'Error!')
      } else {
        open_dialog_with_url(data.response, 'Success!!', '.')
      }
    }, 'json');
  });

  $('.page-nav').click(function (e) {
    e.preventDefault();
    var pageClass = $(this).attr('class').split(' ')[0];
    $('#page').val(pageClass);
    $('#search_form').submit();
  });

  $(".job_detail").click(function () {
    window.document.location = $(this).data("href");
  });

  $(".job_detail .front_end_url").click(function (e) {
    e.stopPropagation();
    e.preventDefault();
    window.open($(this).attr("data-href"), '_blank');
  });

  // Prevent row click when clicking action buttons
  $(".job_detail a, .job_detail button").click(function(e) {
    e.stopPropagation();
  });
</script>
{% endblock script %}
