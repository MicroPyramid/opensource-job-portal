{% extends 'dashboard/base.html' %}
{% load page_tags %}
{% load static %}
{% block stage %}
<style>
.map_wrapper { height: 300px; }
.map_canvas { width: 100%; height: 100%; }
.company { display: none; }
</style>

<div class="space-y-6">
  <!-- Page Header -->
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-4">
      <a href="{% url 'dashboard:job_posts' job_post.job_type %}" class="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-neutral-100 text-neutral-600 hover:bg-neutral-200 transition-colors">
        <i class="fa fa-arrow-left"></i>
      </a>
      <div>
        <h1 class="text-2xl font-semibold text-neutral-900">Edit Job Post</h1>
        <p class="text-sm text-neutral-500 mt-0.5">Update job post details</p>
      </div>
    </div>
  </div>

  <!-- Error Alert -->
  <div class="hidden bg-red-50 border border-red-200 rounded-xl p-4" id="errors_display">
    <div class="flex items-start gap-3">
      <i class="fa fa-times-circle text-red-500 mt-0.5"></i>
      <div>
        <p class="font-medium text-red-800"><span id="error_count"></span></p>
        <p class="text-sm text-red-700 mt-1">Please correct the information as per instructions provided in RED and re-submit the page</p>
      </div>
    </div>
  </div>

  <!-- Job Form -->
  <form id="jobform" name="jobform" method="post">
    <div class="bg-white rounded-xl border border-neutral-200 shadow-sm overflow-hidden">
      <div class="px-6 py-4 border-b border-neutral-200">
        <h3 class="text-lg font-semibold text-neutral-800">
          <i class="fa fa-briefcase text-primary-500 mr-2"></i>Job Details
        </h3>
      </div>
      <div class="p-6 space-y-6">
        <!-- Job Title -->
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-2">Job Title</label>
          <input type="text" class="form-control" placeholder="Enter complete title, Eg. Assistant Manager" name="title" id="title" value="{{ job_post.title }}">
        </div>

        <!-- Job Description -->
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-2">Job Description</label>
          <textarea class="form-control" name="textareacontents" id="textareacontents" rows="6" placeholder="Description">{{ job_post.description }}</textarea>
          <input type="hidden" name="description" id="description" value="{{ job_post.description }}">
        </div>

        <!-- Meta Title -->
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-2">Meta Title</label>
          <textarea class="form-control" name="meta_title" id="meta_title" rows="2" placeholder="Meta Title">{{ job_post.meta_title }}</textarea>
        </div>

        <!-- Meta Description -->
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-2">Meta Description</label>
          <textarea class="form-control" name="meta_description" id="meta_description" rows="2" placeholder="Meta Description">{{ job_post.meta_description }}</textarea>
        </div>

        <!-- Company Selection -->
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-2">Company</label>
          <div class="flex items-center gap-3">
            <select class="form-control select2 flex-1" name="company" id="company">
              <option value="">Select A Company</option>
              {% for company in companies %}
              <option value="{{ company.id }}" class="{{ company.is_active }}" {% if company.id == job_post.company.id %}selected{% endif %}>{{ company.name }} - {{ company.id }}</option>
              {% endfor %}
            </select>
            <span class="company_status inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if job_post.company.is_active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
              {% if job_post.company.is_active %}Active{% else %}Inactive{% endif %}
            </span>
            <a href="" target="_blank" class="edit_company p-1.5 rounded-md hover:bg-primary-100 text-primary-600 transition-colors" title="Edit Company">
              <i class="fa fa-edit"></i>
            </a>
          </div>
          {% if job_post.company.profile_pic %}
          <img src="{{ job_post.company.profile_pic }}" class="w-24 h-24 rounded-lg mt-3 border border-neutral-200">
          {% endif %}
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Major Skill -->
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-2">
              Major Skill {% if job_type != 'government' %}<span class="text-red-500">*</span>{% endif %}
            </label>
            <select class="form-control select2" name="major_skill" id="major_skill">
              {% for skill in skills %}
              <option value="{{ skill.id }}" {% if skill.id == job_post.major_skill.id %}selected{% endif %}>{{ skill.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Technical Skills -->
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-2">Technical Skills</label>
            <select class="form-control select2" multiple name="skills" id="skills">
              {% for skill in skills %}
              <option value="{{ skill.id }}" {% for jskill in job_post.skills.all %}{% if jskill == skill %}selected{% endif %}{% endfor %}>{{ skill.name }}</option>
              {% endfor %}
            </select>
            <input type="hidden" name="status" id="status">
          </div>

          <!-- Educational Qualification -->
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-2">Educational Qualification</label>
            <select class="form-control select2" multiple name="edu_qualification" id="edu_qualification">
              <option value="">Select a Qualification</option>
              {% for qualification in qualifications %}
              <option value="{{ qualification.id }}" {% for edu in job_post.edu_qualification.all %}{% if qualification == edu %}selected{% endif %}{% endfor %}>{{ qualification.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Industry -->
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-2">Industry</label>
            <select class="form-control select2" multiple name="industry" id="industry">
              <option value="">Select an Industry</option>
              {% for industry in industries %}
              <option value="{{ industry.id }}" {% for job_industry in job_post.industry.all %}{% if industry == job_industry %}selected{% endif %}{% endfor %}>{{ industry.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Functional Area -->
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-2">Functional Area</label>
            <select class="form-control select2" multiple name="functional_area" id="functional_area">
              <option value="">Select a Functional Area</option>
              {% for functional_area in functional_areas %}
              <option value="{{ functional_area.id }}" {% for fa in job_post.functional_area.all %}{% if functional_area == fa %}selected{% endif %}{% endfor %}>{{ functional_area.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Job Location -->
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-2">Job Location</label>
            <select class="form-control select2" multiple name="location" id="location">
              {% for city in cities %}
              <option value="{{ city.id }}" {% if city in job_post.location.all %}selected{% endif %}>{{ city.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Pincode -->
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-2">Pincode</label>
            <input type="text" class="form-control" placeholder="Pincode" name="pincode" id="pincode" value="{{ job_post.pincode|default_if_none:'' }}">
          </div>

          <!-- Company Email -->
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-2">Company Email</label>
            <input type="email" class="form-control" placeholder="Company Email" name="company_emails" id="company_emails" value="{{ job_post.company_emails|default_if_none:'' }}">
          </div>

          <!-- Job Status -->
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-2">Job Post Status</label>
            <select class="form-control select2" name="post_status" id="post_status">
              {% for status in status %}
              <option value="{{ status.0 }}" {% if status.1 == job_post.status %}selected{% endif %}>{{ status.1 }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Interview Locations -->
        <div class="border-t border-neutral-200 pt-6">
          <label class="block text-sm font-medium text-neutral-700 mb-4">Interview Locations</label>
          {% if job_post.job_interview_location.all %}
          {% for location in job_post.job_interview_location.all %}
          <div class="another_location mb-4">
            <div id="interview_location_{{ forloop.counter }}" class="interview_location bg-neutral-50 rounded-lg p-4">
              <div class="location_{{ forloop.counter }}" style="display:none">{{ location.get_map_coordinates_list|safe }}</div>
              <div>
                <label class="block text-sm font-medium text-neutral-700 mb-2">Venue Details</label>
                <textarea name="venue_details_{{ forloop.counter }}" id="venue_details_{{ forloop.counter }}" class="form-control interview_location_venue_details_{{ forloop.counter }}" rows="3" placeholder="Company Address">{{ location.venue_details }}</textarea>
                <textarea class="hidden" name="final_location_{{ forloop.counter }}" id="final_location_{{ forloop.counter }}" class="final_location_{{ forloop.counter }}">{{ location.get_coordinates_list }}</textarea>
              </div>
            </div>
          </div>
          {% endfor %}
          {% endif %}
          <button type="button" class="text-sm text-primary-600 hover:text-primary-700" id="another_location">
            <i class="fa fa-plus mr-1"></i>{% if job_post.job_interview_location.all %}Another Location{% else %}Add Location{% endif %}
          </button>
        </div>

        <!-- Salary -->
        <div class="border-t border-neutral-200 pt-6">
          <label class="block text-sm font-medium text-neutral-700 mb-4">Annual Salary</label>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <select class="form-control" name="salary_type" id="salary_type">
                <option value="">Select Salary Type</option>
                <option value="Month" {% if job_post.salary_type == 'Month' %}selected{% endif %}>Per Month</option>
                <option value="Year" {% if job_post.salary_type == 'Year' %}selected{% endif %}>Per Year</option>
              </select>
            </div>
            <div>
              <input type="text" class="form-control" placeholder="Minimum Salary" id="min_salary" name="min_salary" value="{{ job_post.min_salary }}">
            </div>
            <div>
              <input type="text" class="form-control" placeholder="Maximum Salary" id="max_salary" name="max_salary" value="{{ job_post.max_salary }}">
            </div>
          </div>
          <input type="hidden" name="all_skills" id="all_skills">
        </div>

        <!-- Published Message -->
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-2">Published Message</label>
          <textarea class="form-control" placeholder="The message which you enter will display in peeljobs facebook page" name="published_message" id="published_message" rows="3" title="The message which you enter will display in peeljobs facebook page">{{ job_post.published_message }}</textarea>
          <input type="hidden" name="no_of_interview_location" id="no_of_interview_location">
        </div>

        <!-- Form Actions -->
        <div class="flex gap-3 pt-4 border-t border-neutral-200">
          <button type="submit" class="btn btn-primary" id="save">
            <i class="fa fa-save mr-2"></i>Save
          </button>
          <button type="button" class="btn btn-secondary" id="cancel_btn">
            <i class="fa fa-times mr-2"></i>Cancel
          </button>
        </div>
      </div>
    </div>
  </form>
</div>

<style>
.jobposts { display: none; }
.max_experience { display: none; }
</style>
{% endblock %}

{% block script %}
<script type="text/javascript">
$("#cancel_btn").click(function(e) {
  e.preventDefault();
  window.location = "{% url 'dashboard:job_posts' job_post.job_type %}";
});

CKEDITOR.config.allowedContent = true;
CKEDITOR.config.forcePasteAsPlainText = true;
CKEDITOR.config.pasteFromWordRemoveFontStyles = true;
CKEDITOR.config.pasteFromWordRemoveStyles = true;

var editor = CKEDITOR.replace('textareacontents', {});

$('form#jobform').ajaxForm({
  beforeSerialize: function() {
    $("input[name='description']").val(CKEDITOR.instances.textareacontents.getData());
    $('#no_of_interview_location').val($('div.interview_location').length)
  },
  dataType: 'json',
  success: function(data) {
    if (data.error) {
      $('p.error').remove();
      open_dialog('Some Content Missing', 'Error!!')
      $("#errors_display").removeClass('hidden');
      var err_len = Object.keys(data.response).length
      $("#error_count").html("<strong>There are " + err_len + " error(s) in the Form</strong>")
      for (var key in data.response) {
        $('#' + key).after('<p class="text-red-500 text-sm mt-1">' + data.response[key] + '</p>');
      }
    } else {
      $('p.error').remove();
      open_dialog_with_url('Job Post Updated successfully', "Success!!!", "{% url 'dashboard:job_posts' job_post.job_type %}")
    }
  }
});

$(".select2").select2();

$("body").on("click", "#another_location", function(e) {
  last_interview_location = $('div.interview_location').length
  var selected_interview_location = []

  $('.interview_city').each(function() {
    selected_interview_location.push($(this).val())
  })

  $.post('/recruiter/job/interview-location/' + last_interview_location + '/', {'selected_locations': JSON.stringify(selected_interview_location)}, function(data) {
    $("#another_location").before(data);
  });

  location_count = last_interview_location + 1
  location_name = 'location_' + location_count
  searchbox_name = 'search_' + location_count
  $('#location_name').val(location_name)
  $('#searchbox_name').val(searchbox_name)
  $('#location_name').val(location_name)
});

$('.edit_company').attr('href', '/dashboard/companies/edit/' + $('#company').val() + '/')

all_skills = []
$("body").on("change", "select#skills", function(e) {
  e.preventDefault();
  $.each($("select#skills").val(), function(index, value) {
    if (jQuery.inArray(value, all_skills) >= 0) {
    } else {
      all_skills.push(value)
    }
    $("#all_skills").val(all_skills)
  });
})

$.each(all_skills, function(index, value) {
  if (jQuery.inArray(value, $("select#skills").val()) == -1) {
    all_skills.pop(value)
  }
  $("#all_skills").val(all_skills)
});

$("select#skills").on("select2:select", function(evt) {
  var element = evt.params.data.element;
  var $element = $(element);
  $element.detach();
  $(this).append($element);
  $(this).trigger("change");
});

$('#company').select2()
  .on("change", function(e) {
    id = $(this).val()
    status = $(this).find('option:selected').attr('class');
    if (status == 'True') {
      $(".company_status").text('Active').removeClass('bg-red-100 text-red-800').addClass('bg-green-100 text-green-800')
    } else {
      $(".company_status").text('Inactive').removeClass('bg-green-100 text-green-800').addClass('bg-red-100 text-red-800')
    }
    $('.edit_company').attr('href', '/dashboard/companies/edit/' + id + '/')
  })
</script>
{% endblock %}
