{% extends 'dashboard/base.html' %}
{% load page_tags %}
{% block stage %}
<div class="space-y-6">
  <!-- Page Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-neutral-900">Locations</h1>
      <p class="text-sm text-neutral-500 mt-0.5">Manage cities and their job post counts</p>
    </div>
    <div class="flex gap-2">
      <a href="{% url 'dashboard:locations' 'active' %}" class="inline-flex items-center px-4 py-2 rounded-lg text-sm font-medium transition-colors {% if status == 'active' %}bg-primary-600 text-white{% else %}bg-neutral-100 text-neutral-600 hover:bg-neutral-200{% endif %}">
        Active
      </a>
      <a href="{% url 'dashboard:locations' 'inactive' %}" class="inline-flex items-center px-4 py-2 rounded-lg text-sm font-medium transition-colors {% if status == 'inactive' %}bg-primary-600 text-white{% else %}bg-neutral-100 text-neutral-600 hover:bg-neutral-200{% endif %}">
        Inactive
      </a>
    </div>
  </div>

  <!-- Search Form -->
  <div class="bg-white rounded-xl border border-neutral-200 shadow-sm overflow-hidden">
    <div class="p-4">
      <form id="search_form" name="adv-search-form" method="POST">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
          <div class="md:col-span-5">
            <label class="block text-sm font-medium text-neutral-700 mb-2">Search</label>
            <input type="text" name="search" id="search" class="form-control" placeholder="Enter city name..." value="{{ search_term }}"/>
            <input type="hidden" name="page" id="page" value="{{ current_page }}">
          </div>
          <div class="md:col-span-4">
            <label class="block text-sm font-medium text-neutral-700 mb-2">Sort By</label>
            <select name="sort" id="sort" class="form-control" onchange="applySorting()">
              <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Sort by Name</option>
              <option value="job_posts_asc" {% if sort_by == 'job_posts_asc' %}selected{% endif %}>Job Posts (Low to High)</option>
              <option value="job_posts_desc" {% if sort_by == 'job_posts_desc' %}selected{% endif %}>Job Posts (High to Low)</option>
            </select>
          </div>
          <div class="md:col-span-3">
            <button type="submit" class="btn btn-primary w-full">
              <i class="fa fa-search mr-2"></i>Search
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Locations List -->
  <div class="bg-white rounded-xl border border-neutral-200 shadow-sm overflow-hidden">
    <div class="divide-y divide-neutral-100">
      {% for location in locations %}
      <div class="location-item">
        <div class="p-4 flex items-center justify-between hover:bg-neutral-50 transition-colors">
          <div class="flex-1">
            <div class="flex items-center gap-3">
              <span class="font-medium text-neutral-900">{{ location.name }}</span>
              <span class="text-sm text-neutral-500">{{ location.state.name }}, {{ location.state.country.name }}</span>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-700">
                {{ location.num_posts }} jobs
              </span>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button class="edit-btn p-1.5 rounded-md hover:bg-primary-100 text-primary-600 transition-colors" title="Edit">
              <i class="fa fa-edit"></i>
            </button>
            <button class="move-jobs p-1.5 rounded-md hover:bg-blue-100 text-blue-600 transition-colors" data-id="{{ location.id }}" data-name="{{ location.name }} - {{ location.state.name }} - {{ location.state.country.name }}" title="Move Jobs">
              <i class="fa fa-exchange"></i>
            </button>
            <button class="delete p-1.5 rounded-md hover:bg-red-100 text-red-600 transition-colors" data-id="{{ location.id }}" title="Delete">
              <i class="fa fa-trash"></i>
            </button>
          </div>
        </div>

        <!-- Edit Panel (hidden by default) -->
        <div class="edit_panel hidden bg-neutral-50 border-t border-neutral-200 p-4">
          <form id="editform{{ location.id }}" method="post" action="." class="space-y-4">
            <input type="hidden" name="id" value="{{ location.id }}">
            <input type="hidden" name="mode" value="edit">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-neutral-700 mb-2">State</label>
                <select class="form-control" name="state" id="state_{{ location.id }}">
                  {% for state in states %}
                  <option value="{{ state.id }}" {% if state.id == location.state.id %}selected{% endif %}>
                    {{ state.name }} - {{ state.country.name }}
                  </option>
                  {% endfor %}
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-neutral-700 mb-2">Status</label>
                <select class="form-control" name="status" id="status_{{ location.id }}">
                  <option value="Enabled" {% if location.status == "Enabled" %}selected{% endif %}>Enabled</option>
                  <option value="Disabled" {% if location.status == "Disabled" %}selected{% endif %}>Disabled</option>
                </select>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-neutral-700 mb-2">City Name</label>
              <textarea class="form-control" name="name" id="name_{{ location.id }}" rows="2">{{ location.name }}</textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-neutral-700 mb-2">Slug</label>
              <input type="text" class="form-control" name="slug" id="slug_{{ location.id }}" value="{{ location.slug }}">
            </div>

            <div>
              <label class="block text-sm font-medium text-neutral-700 mb-2">Meta Data (JSON)</label>
              <textarea class="form-control" name="meta" id="meta_{{ location.id }}" rows="2" placeholder="Meta Data in JSON Format">{{ location.get_meta_data }}</textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-neutral-700 mb-2">Page Content</label>
              <textarea class="form-control ckeditor_page_content" name="ckeditor_page_content_{{ location.id }}" id="ckeditor_page_content_{{ location.id }}" rows="4" placeholder="Page Content">{{ location.page_content }}</textarea>
              <input type="hidden" name="page_content" id="page_content_{{ location.id }}">
            </div>

            <div class="flex gap-3">
              <button type="button" id="{{ location.id }}" class="update_btn btn btn-primary">
                <i class="fa fa-check mr-2"></i>Update
              </button>
              <button type="button" class="cancel-edit btn btn-secondary">
                <i class="fa fa-times mr-2"></i>Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
      {% empty %}
      <div class="p-12 text-center">
        <div class="w-16 h-16 rounded-full bg-neutral-100 flex items-center justify-center mx-auto mb-4">
          <i class="fa fa-map-marker text-2xl text-neutral-400"></i>
        </div>
        <p class="text-neutral-500">No locations found</p>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Pagination -->
  {% if locations %}
  <div class="flex justify-center">
    {% get_page current_page last_page as pages %}
    <nav class="flex items-center gap-1">
      {% if current_page != 1 %}
      <a href="?{% if search_term %}search={{ search_term }}&{% endif %}{% if sort_by %}sort={{ sort_by }}&{% endif %}page={{ previous_page }}" class="p-2 rounded-lg hover:bg-neutral-100 text-neutral-600 transition-colors">
        <i class="fa fa-angle-double-left"></i>
      </a>
      <a href="?{% if search_term %}search={{ search_term }}&{% endif %}{% if sort_by %}sort={{ sort_by }}&{% endif %}page={{ prev_page }}" class="p-2 rounded-lg hover:bg-neutral-100 text-neutral-600 transition-colors">
        <i class="fa fa-angle-left"></i>
      </a>
      <a href="?{% if search_term %}search={{ search_term }}&{% endif %}{% if sort_by %}sort={{ sort_by }}&{% endif %}page=1" class="px-3 py-2 rounded-lg hover:bg-neutral-100 text-neutral-600 transition-colors text-sm">first</a>
      {% endif %}
      {% for s in pages %}
      <a href="?{% if search_term %}search={{ search_term }}&{% endif %}{% if sort_by %}sort={{ sort_by }}&{% endif %}page={{ s }}" class="px-3 py-2 rounded-lg text-sm transition-colors {% if s == current_page %}bg-primary-600 text-white{% else %}hover:bg-neutral-100 text-neutral-600{% endif %}">{{ s }}</a>
      {% endfor %}
      {% if current_page != last_page %}
      <a href="?{% if search_term %}search={{ search_term }}&{% endif %}{% if sort_by %}sort={{ sort_by }}&{% endif %}page={{ last_page }}" class="px-3 py-2 rounded-lg hover:bg-neutral-100 text-neutral-600 transition-colors text-sm">last</a>
      <a href="?{% if search_term %}search={{ search_term }}&{% endif %}{% if sort_by %}sort={{ sort_by }}&{% endif %}page={{ aft_page }}" class="p-2 rounded-lg hover:bg-neutral-100 text-neutral-600 transition-colors">
        <i class="fa fa-angle-right"></i>
      </a>
      <a href="?{% if search_term %}search={{ search_term }}&{% endif %}{% if sort_by %}sort={{ sort_by }}&{% endif %}page={{ after_page }}" class="p-2 rounded-lg hover:bg-neutral-100 text-neutral-600 transition-colors">
        <i class="fa fa-angle-double-right"></i>
      </a>
      {% endif %}
    </nav>
  </div>
  {% endif %}
</div>

<!-- Move Jobs Modal -->
<div class="modal fade" id="moveJobsModal" tabindex="-1" role="dialog" aria-labelledby="moveJobsModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content rounded-xl overflow-hidden">
      <div class="px-6 py-4 border-b border-neutral-200 bg-white">
        <div class="flex items-center justify-between">
          <h5 class="text-lg font-semibold text-neutral-900">Move Jobs to Another City</h5>
          <button type="button" class="close p-1 rounded-md hover:bg-neutral-100" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true" class="text-neutral-500">&times;</span>
          </button>
        </div>
      </div>
      <form id="moveJobsForm">
        <div class="p-6 space-y-4 bg-white">
          <input type="hidden" id="fromCityId" name="from_city_id">
          <input type="hidden" name="mode" value="move_jobs">

          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-2">From City</label>
            <input type="text" id="fromCityName" class="form-control bg-neutral-50" readonly>
          </div>

          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-2">To City</label>
            <select id="toCitySelect" name="to_city_id" class="form-control" required>
              <option value="">Select destination city</option>
              {% for city in cities %}
              <option value="{{ city.id }}">{{ city.name }} - {{ city.state.name }} - {{ city.state.country.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
            <div class="flex items-start gap-3">
              <i class="fa fa-exclamation-triangle text-amber-500 mt-0.5"></i>
              <p class="text-sm text-amber-700">This will move all job posts from the source city to the destination city. This action cannot be undone.</p>
            </div>
          </div>
        </div>
        <div class="px-6 py-4 border-t border-neutral-200 bg-neutral-50 flex justify-end gap-3">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Move Jobs</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock stage %}

{% block script %}
<script type="text/javascript">
function applySorting() {
  var sortValue = document.getElementById('sort').value;
  var searchValue = document.getElementById('search').value;
  var currentUrl = new URL(window.location);

  currentUrl.searchParams.set('sort', sortValue);
  if (searchValue) {
    currentUrl.searchParams.set('search', searchValue);
  } else {
    currentUrl.searchParams.delete('search');
  }
  currentUrl.searchParams.delete('page');

  window.location.href = currentUrl.toString();
}

$(document).ready(function() {
  // Edit button click
  $('.edit-btn').click(function(e) {
    e.preventDefault();
    var $panel = $(this).closest('.location-item').find('.edit_panel');
    $panel.toggleClass('hidden');

    if (!$panel.hasClass('hidden')) {
      var ckeditor_name = $panel.find('.ckeditor_page_content').attr('name');
      if (!CKEDITOR.instances[ckeditor_name]) {
        CKEDITOR.config.allowedContent = true;
        CKEDITOR.replace(ckeditor_name);
      }
    }
  });

  // Cancel edit
  $('.cancel-edit').click(function(e) {
    e.preventDefault();
    $(this).closest('.edit_panel').addClass('hidden');
  });
});

// Update button
$(".update_btn").click(function(e) {
  e.preventDefault();
  var id = $(this).attr('id');
  var ckeditor_name = 'ckeditor_page_content_' + id;
  var get_data = CKEDITOR.instances[ckeditor_name].getData();
  $('#page_content_' + id).val(get_data);

  $.post('.', $("#editform" + id).serialize(), function(data) {
    if (data.error == false) {
      alert(data.message);
      location.reload();
    } else {
      $('p.error').remove();
      if (typeof data.message === 'object') {
        for (var key in data.message) {
          $('#' + key + '_' + data.id).after("<p class='text-red-500 text-sm mt-1'>" + data.message[key] + "</p>");
        }
      } else {
        alert('Error: ' + data.message);
      }
    }
  }, 'json').fail(function() {
    alert('An error occurred while processing your request.');
  });
});

// Delete
$('.delete').click(function(e) {
  e.preventDefault();
  var id = $(this).attr('data-id');

  if (confirm('Do you want to delete this City?')) {
    $.post('.', {mode: 'remove_city', id: id}, function(data) {
      if (data.error == false) {
        alert(data.message);
        location.reload();
      } else {
        alert('Error: ' + data.message);
      }
    }, 'json').fail(function() {
      alert('An error occurred while processing your request.');
    });
  }
});

// Move Jobs
$('.move-jobs').click(function(e) {
  e.preventDefault();
  var cityId = $(this).attr('data-id');
  var cityName = $(this).attr('data-name');

  $('#fromCityId').val(cityId);
  $('#fromCityName').val(cityName);
  $('#toCitySelect').val('');
  $('#moveJobsModal').modal('show');
});

$('#moveJobsForm').on('submit', function(e) {
  e.preventDefault();

  var fromCityId = $('#fromCityId').val();
  var toCityId = $('#toCitySelect').val();
  var fromCityName = $('#fromCityName').val();
  var toCityName = $('#toCitySelect option:selected').text();

  if (!toCityId) {
    alert('Please select a destination city');
    return;
  }

  if (fromCityId === toCityId) {
    alert('Source and destination cities cannot be the same');
    return;
  }

  if (confirm(`Are you sure you want to move all jobs from "${fromCityName}" to "${toCityName}"?`)) {
    $.post('.', $(this).serialize(), function(data) {
      if (data.error == false) {
        alert(data.message);
        $('#moveJobsModal').modal('hide');
        location.reload();
      } else {
        alert('Error: ' + data.message);
      }
    }, 'json').fail(function() {
      alert('An error occurred while processing your request.');
    });
  }
});
</script>
{% endblock script %}
